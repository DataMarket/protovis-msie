/*!
 * Protovis MSIE/VML addon
 * Copyright (C) 2011 by DataMarket <http://datamarket.com>
 * Dual licensed under the terms of the MIT or GPL Version 2 software licenses.
 * 
 * This software includes code from jQuery, http://jquery.com/
 * jQuery is licensed under the MIT or GPL Version 2 license.
 * 
 * This software includes code from the Protovis, http://mbostock.github.com/protovis/
 * Protovis is licensed under the BSD license.
 * 
 */// detect SVG support
pv.have_SVG=!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect,pv.have_VML=function(e,t,n){return t=e.createElement("div"),t.innerHTML='<v:shape adj="1" />',n=t.firstChild,n.style.behavior="url(#default#VML)",n?typeof n.adj=="object":!0}(document),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var n=this.length>>>0,r=!isFinite(t)||t<0?0:t>this.length?this.length:t;for(;r<n;r++)if(this[r]===e)return r;return-1}),!pv.have_SVG&&pv.have_VML&&function(){typeof Date.now!="function"&&(Date.now=function(){return new Date*1});var e={round:function(e){return Math.round(e*21.6)},styles:null,pre:"<v:",post:' class="msvml">',block:{group:1,shape:1,shapetype:1,line:1,polyline:1,curve:1,rect:1,roundrect:1,oval:1,arc:1,image:1},ends:{butt:"flat",round:"round",square:"square",flat:"flat"},joins:{bevel:"bevel",round:"round",miter:"miter"},cursorstyles:{hand:"pointer",crosshair:1,pointer:1,move:1,text:1,wait:1,help:1,progress:1,"n-resize":1,"ne-resize":1,"nw-resize":1,"s-resize":1,"se-resize":1,"sw-resize":1,"e-resize":1,"w-resize":1},text_shim:null,_textcache:{},text_dims:function(t,n){n in e._textcache||(e._textcache[n]={});if(t in e._textcache[n])return e._textcache[n][t];var r=e.text_shim;return r.style.font=n,r.innerText=t,e._textcache[n][t]={fontsize:parseInt(r.style.fontSize,10),height:r.offsetHeight,width:r.offsetWidth}},d2r:Math.PI*2/360,get_dim:function(e,t){var n=t||{};n.translate_x=0,n.translate_y=0;if(e.transform){var r=/translate\((\d+(?:\.\d+)?)(?:,(\d+(?:\.\d+)?))?\)/.exec(e.transform);r&&r[1]&&(n.translate_x=parseFloat(r[1])),r&&r[2]&&(n.translate_y=parseFloat(r[2]));var i=/rotate\((\-?\d+\.\d+|\-?\d+)\)/.exec(e.transform);i&&(n.rotation=parseFloat(i[1])%360)}return n.x=parseFloat(e.x||0),n.y=parseFloat(e.y||0),"width"in e&&(n.width=parseInt(e.width,10)),"height"in e&&(n.height=parseInt(e.height,10)),n},elm_defaults:{g:{rewrite:"span",attr:function(t,n,r){var i=e.get_dim(t);r.style.cssText="position:absolute;zoom:1;left:"+(i.translate_x+i.x)+"px;top:"+(i.translate_y+i.y)+"px;"}},line:{rewrite:"shape",attr:function(t,n,r){var i=parseFloat(t.x1||0),s=parseFloat(t.y1||0),o=parseFloat(t.x2||0),u=parseFloat(t.y2||0),a=e.round;r.coordorigin="0,0",r.coordsize="21600,21600",e.path(r).v="M "+a(i)+" "+a(s)+" L "+a(o)+" "+a(u)+" E",e.stroke(r,t)},css:"top:0px;left:0px;width:1000px;height:1000px"},rect:{rewrite:"shape",attr:function(t,n,r){var i=e.get_dim(t),s=e.path(r),o=e.round;r.coordorigin="0,0",r.coordsize="21600,21600";var u=o(i.translate_x+i.x),a=o(i.translate_y+i.y),f=o(i.width),l=o(i.height);s.v="M "+u+" "+a+" L "+(u+f)+" "+a+" L "+(u+f)+" "+(a+l)+" L "+u+" "+(a+l)+" x",e.stroke(r,t),e.fill(r,t)},css:"top:0px;left:0px;width:1000px;height:1000px"},path:{rewrite:"shape",attr:function(t,n,r){var i=e.get_dim(t),s=r.style;s.left=i.translate_x+i.x+"px",s.top=i.translate_y+i.y+"px";if(i.rotation){var o=0;i.rotation>=0&&i.rotation<=360?o=i.rotation:i.rotation<0&&i.rotation>=-360?o=360+i.rotation:i.rotation>360?o=i.rotation%360:i.rotation<-360&&(o=360-i.rotation%360);var u=o*(Math.PI*2/360),a=Math.sin(u),f=Math.cos(u);s["-ms-filter"]="progid:DXImageTransform.Microsoft.Matrix(M11="+f+", M12="+ -a+", M21="+a+", M22="+f+",sizingMethod='auto expand')",s.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+f+", M12="+ -a+", M21="+a+", M22="+f+",sizingMethod='auto expand')"}r.coordorigin="0,0",r.coordsize="21600,21600",e.path(r,t.d),e.fill(r,t),e.stroke(r,t)},css:"top:0px;left:0px;width:1000px;height:1000px"},circle:{rewrite:"oval",attr:function(t,n,r){var i=e.get_dim(t),s=r.style,o=parseFloat(t.cx||0)+.7,u=parseFloat(t.cy||0)+.7,a=parseFloat(t.r||0)+.5;s.top=i.translate_y+u-a+"px",s.left=i.translate_x+o-a+"px",s.width=a*2+"px",s.height=a*2+"px",e.fill(r,t),e.stroke(r,t)}},text:{rewrite:"span"},svg:{rewrite:"span",css:"position:relative;overflow:hidden;display:inline-block;~display:block;"},"vml:path":{rewrite:"path"},"vml:stroke":{rewrite:"stroke"},"vml:fill":{rewrite:"fill"}},_elmcache:{span:document.createElement("span"),div:document.createElement("div")},createElement:function(t,n){var r,i=e._elmcache,s=e.elm_defaults[t]||{},o=s.rewrite||t;return o in i?r=i[o].cloneNode(!1):(i[o]=document.createElement(e.pre+o+e.post),o in e.block&&(i[o].className+=" msvml_block"),r=i[o].cloneNode(!1)),s.css&&(r.style.cssText=s.css),r},_hex:pv.range(0,256).map(function(e){return pv.Format.pad("0",2,e.toString(16))}),_colorcache:{none:"transparent"},color:function(t,n){return!(t in e._colorcache)&&(n=/^rgb\((\d+),(\d+),(\d+)\)$/i.exec(t))&&(e._colorcache[t]="#"+e._hex[n[1]]+e._hex[n[2]]+e._hex[n[3]]),e._colorcache[t]||t},fill:function(t,n){var r=t.getElementsByTagName("fill")[0];r||(r=t.appendChild(e.createElement("vml:fill"))),!n.fill||n.fill==="none"?r.on=!1:(r.on="true",r.color=e.color(n.fill),r.opacity=parseFloat(n["fill-opacity"]||"1")||"1")},stroke:function(t,n){var r=t.getElementsByTagName("stroke")[0];r||(r=t.appendChild(e.createElement("vml:stroke"))),!n.stroke||n.stroke==="none"?(r.on="false",r.weight="0"):(r.on="true",r.weight=parseFloat(n["stroke-width"]||"1")/1.25,r.color=e.color(n.stroke)||"black",r.opacity=parseFloat(n["stroke-opacity"]||"1")||"1",r.joinstyle=e.joins[n["stroke-linejoin"]]||"miter")},path:function(t,n){var r=t.getElementsByTagName("path")[0];return r||(r=t.appendChild(e.createElement("vml:path"))),arguments.length>1&&(r.v=e.rewritePath(n)),r},init:function(){e.text_shim||(e.text_shim=document.getElementById("pv_vml_text_shim")||document.createElement("span"),e.text_shim.id="protovisvml_text_shim",e.text_shim.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline-block;white-space:nowrap;",document.body.appendChild(e.text_shim));if(!e.styles){e.styles=document.getElementById("protovisvml_styles")||document.createElement("style"),e.styles.id!=="protovisvml_styles"&&(e.styles.id="protovisvml_styles",document.documentElement.firstChild.appendChild(e.styles),e.styles.styleSheet.addRule(".msvml","behavior:url(#default#VML);"),e.styles.styleSheet.addRule(".msvml_block","position:absolute;top:0;left:0;"));try{document.namespaces.v||document.namespaces.add("v","urn:schemas-microsoft-com:vml")}catch(t){e.pre="<",e.post=' class="msvml" xmlns="urn:schemas-microsoft.com:vml">'}}},_pathcache:{},rewritePath:function(t,n){var r=0,i=0,s=e.round;if(!t)return t;if(t in e._pathcache)return e._pathcache[t];t=t.replace(/(\d*)((\.*\d*)(e ?-?\d*))/g,"$1");var o=t.match(/([MLHVCSQTAZ][^MLHVCSQTAZ]*)/gi),u=[],a=[];for(var f=0,l=o.length;f<l;f++){var c=o[f],h=c.charAt(0),p=c.substring(1).split(/[, ]/);switch(h){case"M":h="m",r=s(p[0]),i=s(p[1]),p=[r,i];break;case"m":h="m",r+=s(p[0]),i+=s(p[1]),p=[r,i];break;case"A":h="l",p=[r=s(p[5]),i=s(p[6])];break;case"L":h="l";for(var f=0;f<p.length;f++)p[f]=s(p[f]);break;case"l":h="l",p=[r+=s(p[0]),i+=s(p[1])];break;case"H":h="l",p=[r=s(p[0]),i];break;case"h":h="l",p=[r+=s(p[0]),i];break;case"V":h="l",p=[r,i=s(p[0])];break;case"v":h="l",p=[r,i+=s(p[0])];break;case"C":h="c",a=p=[s(p[0]),s(p[1]),s(p[2]),s(p[3]),r=s(p[4]),i=s(p[5])];break;case"c":h="c",a=p=[r+s(p[0]),i+s(p[1]),r+s(p[2]),i+s(p[3]),r+=s(p[4]),i+=s(p[5])];break;case"S":h="c",a=p=[a[4]+(a[4]-a[2]),a[5]+(a[5]-a[3]),s(p[0]),s(p[1]),r=s(p[2]),i=s(p[3])];break;case"s":h="c",a=p=[a[4]+(a[4]-a[2]),a[5]+(a[5]-a[3]),r+s(p[0]),i+s(p[1]),r+=s(p[2]),i+=s(p[3])];break;case"Q":h="c";var d=s(p[0]),v=s(p[1]),m=s(p[2]),g=s(p[3]);p=[~~(r+(d-r)*2/3),~~(i+(v-i)*2/3),~~(d+(m-d)/3),~~(v+(g-v)/3),r=m,i=g];break;case"q":h="l",r+=s(p[2]),i+=s(p[3]),p=[r,i];break;case"Z":case"z":h="xe",p=[];break;default:h="",p=[]}u.push(h,p.join(","))}return e._pathcache[t]=u.join("")+"e"}};pv.VmlScene={scale:1,events:["mousewheel","mousedown","mouseup","mouseover","mouseout","mousemove","click","dblclick"],implicit:{css:{}},copy_functions:function(e){for(var t in e)typeof e[t]=="function"&&!(t in pv.VmlScene)&&(pv.VmlScene[t]=e[t])}},pv.VmlScene.copy_functions(pv.SvgScene),pv.Scene=pv.VmlScene,pv.VmlScene.expect=function(t,n,r,i){i=i||{};var s=e.elm_defaults[n]||{},o=s.rewrite||n;if(t){if(t.tagName.toUpperCase()!==o.toUpperCase()){var u=e.createElement(n);t.parentNode.replaceChild(u,t),t=u}}else t=e.createElement(n);"attr"in s&&s.attr(r,i,t);if(r.cursor in e.cursorstyles){var a=e.cursorstyles[r.cursor];i.cursor=a===1?r.cursor:a}for(var f in i){var l=i[f];l==null?t.style.removeAttribute(f):t.style[f]=l}return t},pv.VmlScene.append=function(e,t,n){return e.$scene={scenes:t,index:n},e=this.title(e,t[n]),(!e.parentNode||e.parentNode.nodeType===11)&&t.$g.appendChild(e),e.nextSibling},pv.VmlScene.title=function(e,t){return e.title=t.title||"",e},pv.VmlScene.panel=function(t){var n=t.$g,r=n&&n.firstChild;for(var i=0;i<t.length;i++){var s=t[i];if(!s.visible)continue;if(!t.parent){s.canvas.style.display="inline-block",s.canvas.style.zoom=1,n&&n.parentNode!=s.canvas&&(n=s.canvas.firstChild,r=n&&n.firstChild);if(!n){e.init(),n=s.canvas.appendChild(e.createElement("svg"));for(var o=0;o<this.events.length;o++)n.addEventListener?n.addEventListener(this.events[o],this.dispatch,!1):n.attachEvent("on"+this.events[o],this.dispatch);r=n.firstChild}t.$g=n;var u=s.width+s.left+s.right,a=s.height+s.top+s.bottom;n.style.width=u+"px",n.style.height=a+"px",n.style.clip="rect(0px "+u+"px "+a+"px 0px)"}r=this.fill(r,t,i);var f=this.scale,l=s.transform,c=s.left+l.x,h=s.top+l.y;this.scale*=l.k;for(var o=0;o<s.children.length;o++){s.children[o].$g=r=this.expect(r,"g",{transform:"translate("+c+","+h+")"+(l.k!=1?" scale("+l.k+")":"")}),this.updateAll(s.children[o]);if(!r.parentNode||r.parentNode.nodeType===11){n.appendChild(r);var p=e.elm_defaults[r.svgtype];p&&typeof p.onappend=="function"&&p.onappend(r,t[i])}r=r.nextSibling}this.scale=f,r=this.stroke(r,t,i)}return r},pv.VmlScene.fill=function(t,n,r){var i=n[r],s=i.fillStyle;if(s.opacity||i.events=="all")t=this.expect(t,"div",{},{cursor:i.cursor,left:i.left,top:i.top,width:i.width,height:i.height,border:"none",background:e.color(s.color),position:"absolute"}),t=this.append(t,n,r);return t},pv.VmlScene.stroke=function(t,n,r){var i=n[r],s=i.strokeStyle;if(s.opacity||i.events=="all"){var o=Math.round(i.lineWidth/this.scale);t=this.expect(t,"div",{},{cursor:i.cursor,left:i.left-o/2,top:i.top-o/2,width:Math.max(1e-10,i.width)-o,height:Math.max(1e-10,i.height)-o,border:o+"px solid "+e.color(s.color),zoom:1,position:"absolute"}),t=this.append(t,n,r)}return t},function(){function i(e){if(e&&e.type){this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=n;if(e.defaultPrevented||e.returnValue===!1||e.getPreventDefault&&e.getPreventDefault())this.isDefaultPrevented=t}else this.type=e;this.timeStamp=Date.now()}var t=function(){return!0},n=function(){return!1},r=["altKey","attrChange","attrName","bubbles","button","cancelable","charCode","clientX","clientY","ctrlKey","currentTarget","data","detail","eventPhase","fromElement","handler","keyCode","layerX","layerY","metaKey","newValue","offsetX","offsetY","pageX","pageY","prevValue","relatedNode","relatedTarget","screenX","screenY","shiftKey","srcElement","target","toElement","view","wheelDelta","which"];i.prototype={preventDefault:function(){this.isDefaultPrevented=t;var e=this.originalEvent;if(!e)return;e.preventDefault?e.preventDefault():e.returnValue=!1},stopPropagation:function(){this.isPropagationStopped=t;var e=this.originalEvent;if(!e)return;e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=t,this.stopPropagation()},isDefaultPrevented:n,isPropagationStopped:n,isImmediatePropagationStopped:n},e.fixEvent=function(e){var t=e;e=new i(t);for(var n=0,s=r.length;n<s;n++){var o=r[n];e[o]=t[o]}e.target||(e.target=e.srcElement||document),!e.relatedTarget&&e.fromElement&&(e.relatedTarget=e.fromElement===e.target?e.toElement:e.fromElement);if(e.pageX==null&&e.clientX!=null){var u=document.documentElement,a=document.body;e.pageX=e.clientX+(u&&u.scrollLeft||a&&a.scrollLeft||0)-(u&&u.clientLeft||a&&a.clientLeft||0),e.pageY=e.clientY+(u&&u.scrollTop||a&&a.scrollTop||0)-(u&&u.clientTop||a&&a.clientTop||0)}return e.which==null&&(e.charCode!=null||e.keyCode!=null)&&(e.which=e.charCode!=null?e.charCode:e.keyCode),!e.metaKey&&e.ctrlKey&&(e.metaKey=e.ctrlKey),!e.which&&e.button!==undefined&&(e.which=e.button&1?1:e.button&2?3:e.button&4?2:0),e.type==="mousewheel"&&(e.wheel=e.wheelDelta),e}}(),pv.listener=function(t,n){return t.$listener||(t.$listener=function(n){try{return pv.event=e.fixEvent(n||window.event),t.call(this,pv.event)}catch(n){pv.error(n)}finally{delete pv.event}})},pv.listen=function(e,t,n){return n=pv.listener(n,e),e===window&&(e=document.documentElement),e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)},pv.VmlScene.dispatch=pv.listener(function(e){var t=e.target.$scene;t&&pv.Mark.dispatch(e.type,t.scenes,t.index)&&e.preventDefault()}),pv.VmlScene.image=function(e){var t=e.$g.firstChild;for(var n=0;n<e.length;n++){var r=e[n];if(!r.visible)continue;t=this.fill(t,e,n);if(!r.image){t=new Image,t.src=r.url;var i=t.style;i.position="absolute",i.top=r.top,i.left=r.left,i.width=r.width,i.height=r.height,i.cursor=r.cursor,i.msInterpolationMode="bicubic"}t=this.append(t,e,n),t=this.stroke(t,e,n)}return t},pv.VmlScene.label=function(t){var n=t.$g.firstChild,r=Math.round;for(var i=0;i<t.length;i++){var s=t[i];if(!s.visible)continue;var o=s.textStyle;if(!o.opacity||!s.text)continue;var u={};s.cursor&&(u.cursor=s.cursor);var a=s.text.replace(/\s+/g,"\u00a0"),f=e.text_dims(a,s.font),l=0,c=0;s.textBaseline==="middle"?c-=f.fontsize/2:s.textBaseline==="top"?c+=s.textMargin:s.textBaseline==="bottom"&&(c-=s.textMargin+f.fontsize),s.textAlign==="center"?l-=f.width/2:s.textAlign==="right"?l-=f.width+s.textMargin:s.textAlign==="left"&&(l+=s.textMargin),n=this.expect(n,"text",u,{font:s.font,textDecoration:s.textDecoration,top:Math.round(s.top+c)+"px",left:Math.round(s.left+l)+"px",position:"absolute",display:"block",lineHeight:1,whiteSpace:"nowrap",zoom:1,cursor:"default",color:e.color(o.color)||"black"}),n.innerText=a;var h=180*s.textAngle/Math.PI;if(h){var p=~~h%360*e.d2r,d=Math.cos(p),v=Math.sin(p);n.style.filter=["progid:DXImageTransform.Microsoft.Matrix(","M11=",d.toFixed(8),",","M12=",-v.toFixed(8),",","M21=",v.toFixed(8),",","M22=",d.toFixed(8),",sizingMethod='auto expand')\";"].join("")}else n.style.filter="";n=this.append(n,t,i)}return n},pv.VmlScene.wedge=function(t){var n=t.$g.firstChild,r=e.round;for(var i=0;i<t.length;i++){var s=t[i];if(!s.visible)continue;var o=s.fillStyle,u=s.strokeStyle;if(!o.opacity&&!u.opacity)continue;n=this.expect(n,"path",{"pointer-events":s.events,cursor:s.cursor,transform:"translate("+s.left+","+s.top+")",d:"",fill:o.color,"fill-rule":"evenodd","fill-opacity":o.opacity||null,stroke:u.color,"stroke-opacity":u.opacity||null,"stroke-width":u.opacity?s.lineWidth/this.scale:null});var a=n.getElementsByTagName("path")[0];a||(a=e.make("path"),n.appendChild(a));var f=r(s.innerRadius),l=r(s.outerRadius),c;if(s.angle>=2*Math.PI)f?c="AE0,0 "+l+","+l+" 0 23592960"+"AL0,0 "+f+","+f+" 0 23592960":c="AE0,0 "+l+","+l+" 0 23592960";else{var h=Math.round(s.startAngle/Math.PI*11796480),p=Math.round(s.angle/Math.PI*11796480);f?c="AE 0,0 "+l+","+l+" "+ -h+" "+ -p+" 0,0 "+f+","+f+" "+ -(h+p)+" "+p+"X":c="M0,0AE0,0 "+l+","+l+" "+ -h+" "+ -p+"X"}a.v=c,n=this.append(n,t,i)}return n}}()